<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragments/head :: head"></head>

<body>
  <header th:replace="fragments/navbar :: navbar"></header>

  <section class="section">
    <div class="container">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <div>
              <h1 class="title">Asignación de turnos</h1>
              <p class="subtitle">
                <span th:text="${selectedDiaNombre}">Lunes</span>
              </p>
            </div>
          </div>
        </div>
        <div class="level-right" sec:authorize="hasRole('ADMIN')">
          <div class="level-item">
            <a class="button is-primary" th:href="@{/turnos}">
              <span class="icon">
                <i class="fa-solid fa-user-clock"></i>
              </span>
              <span>Gestionar turnos</span>
            </a>
          </div>
        </div>
      </div>

      <div class="tabs is-toggle is-small is-fullwidth">
        <ul>
          <li th:each="d : ${dias}" th:classappend="${selectedDia == d.valor} ? 'is-active'">
            <a th:href="@{/asignaciones(dia=${d.valor})}" th:text="${d.nombre}">Lunes</a>
          </li>
        </ul>
      </div>

      <div th:if="${successMessage != null}" class="notification is-success">
        <button class="delete"></button>
        <span th:text="${successMessage}"></span>
      </div>
      <div th:if="${errorMessage != null}" class="notification is-danger">
        <button class="delete"></button>
        <span th:text="${errorMessage}"></span>
      </div>

      <div th:if="${#lists.isEmpty(turnosDelDia)}" class="notification is-info is-light">
        No hay turnos para este día.
      </div>

      <div th:each="t : ${turnosDelDia}" class="box">
        <div class="level mb-3">
          <div class="level-left">
            <div class="level-item">
              <h2 class="title is-5">
                <span th:text="${#dates.format(t.ingreso, 'HH:mm')}">06:00</span>
                <span class="has-text-grey">-</span>
                <span th:text="${#dates.format(t.salida, 'HH:mm')}">12:00</span>
              </h2>
            </div>
          </div>
          <div class="level-right" sec:authorize="hasRole('ADMIN')">
            <div class="level-item">
              <form th:action="@{/asignaciones/asignar}" method="post" class="is-flex is-align-items-center">
                <input type="hidden" name="dia" th:value="${selectedDia}" />
                <input type="hidden" name="turnoId" th:value="${t.id}" />
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div th:if="${!#lists.isEmpty(usuariosDisponiblesPorTurno[t.id])}" class="field has-addons mb-0">
                  <div class="control">
                    <div class="select is-small">
                      <select name="userId" required>
                        <option value="" selected disabled>Seleccionar usuario…</option>
                        <option th:each="u : ${usuariosDisponiblesPorTurno[t.id]}" th:value="${u.id}"
                          th:text="|${u.apellido}, ${u.nombre} (@${u.username}) - ${u.role}|">
                          Usuario
                        </option>
                      </select>
                    </div>
                  </div>
                  <div class="control">
                    <button type="submit" class="button is-small is-primary">
                      <span class="icon is-small">
                        <i class="fa-solid fa-plus"></i>
                      </span>
                      <span>Asignar</span>
                    </button>
                  </div>
                </div>

                <div th:if="${#lists.isEmpty(usuariosDisponiblesPorTurno[t.id])}" class="has-text-grey is-size-7">
                  No hay usuarios disponibles para asignar a este turno.
                </div>
              </form>
            </div>
          </div>
        </div>

        <div th:with="asigs=${asignacionesPorTurno[t.id]}">
          <div th:if="${asigs == null || #lists.isEmpty(asigs)}" class="notification is-light">
            No hay usuarios asignados a este turno.
          </div>

          <table th:if="${asigs != null && !#lists.isEmpty(asigs)}" class="table is-fullwidth is-striped is-hoverable">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Username</th>
                <th class="has-text-centered" sec:authorize="hasRole('ADMIN')">Quitar</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="a : ${asigs}">
                <td th:text="|${a.usuario.apellido}, ${a.usuario.nombre}|">Apellido, Nombre</td>
                <td>
                  <span class="tag is-light" th:text="${a.usuario.role}">ROLE</span>
                </td>
                <td th:text="${a.usuario.username}">usuario</td>
                <td class="has-text-centered" sec:authorize="hasRole('ADMIN')">
                  <form th:action="@{'/asignaciones/quitar/' + ${a.id}}" method="post" style="display:inline">
                    <input type="hidden" name="dia" th:value="${selectedDia}" />
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="button is-small is-danger is-light"
                      onclick="return confirm('¿Quitar asignación?');">
                      <span class="icon is-small">
                        <i class="fa-solid fa-trash"></i>
                      </span>
                    </button>
                  </form>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</body>

</html>